// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  nick      String   @unique
  nombre    String?
  email     String?  @unique
  password  String?
  avatar    String?
  centro    String?
  curso     String?
  tipo      String?  // "estudiante" o "docente"
  language  String?  @default("es") // Idioma preferido
  fechaInscripcion DateTime?
  likes     Int      @default(0)
  respuestasAcertadas Int @default(0)
  competicionesSuperadas Int @default(0)
  concursosGanados Int @default(0)
  comentariosRecibidos Int @default(0)
  historiasCreadas Int @default(0)
  anosEnStoryUp Int @default(0)
  premium   Boolean  @default(false)
  // Campos para estadísticas JSON
  stats_individual Json?
  stats_centro Json?
  stats_docente Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  historias     Historia[]
  noticias      Noticia[]
  amigosComoUser    Amigo[] @relation("amigosComoUser")
  amigosComoAmigo   Amigo[] @relation("amigosComoAmigo")
  chat          Chat[]
  campeonatos   Campeonato[]
  concursos     Concurso[]
  solicitudes   SolicitudPremium[]
  sesiones      SesionUsuario[]
  premios       PremioMensual[]
  torneosGanados Torneo[] @relation("torneosGanados")
  stats         UserStats?
  championshipResults ChampionshipResult[]
  premiumData   PremiumData?
  torneoPremium TorneoPremium?
  competicionPremium CompeticionPremium?
  userTrofeos   UserTrofeo[]

  @@map("users")
}

model Historia {
  id          Int      @id @default(autoincrement())
  titulo      String
  contenido   String
  autorId     Int
  autor       User     @relation(fields: [autorId], references: [id])
  likes       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("historias")
}

model Noticia {
  id          Int      @id @default(autoincrement())
  titulo      String
  contenido   String
  autorId     Int
  autor       User     @relation(fields: [autorId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("noticias")
}

model Amigo {
  id        Int      @id @default(autoincrement())
  userId    Int
  amigoId   Int
  user      User     @relation("amigosComoUser", fields: [userId], references: [id])
  amigo     User     @relation("amigosComoAmigo", fields: [amigoId], references: [id])
  createdAt DateTime @default(now())

  @@map("amigos")
}

model Chat {
  id        Int      @id @default(autoincrement())
  userId    Int
  mensaje   String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@map("chat")
}

model Campeonato {
  id          Int      @id @default(autoincrement())
  nombre      String
  descripcion String?
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())

  @@map("campeonatos")
}

model Concurso {
  id          Int      @id @default(autoincrement())
  numero      Int
  titulo      String
  texto       String
  inicio      DateTime
  fin        DateTime
  autor       String
  ganador     String?
  fechaFinal  DateTime?
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())

  @@map("concursos")
}

model SolicitudPremium {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  estado      String   @default("pendiente")
  createdAt   DateTime @default(now())

  @@map("solicitudes_premium")
}

model SesionUsuario {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@map("sesiones_usuario")
}

model Configuracion {
  id    Int    @id @default(autoincrement())
  clave String @unique
  valor String

  @@map("configuracion")
}

model PalabraProhibida {
  id      Int    @id @default(autoincrement())
  palabra String @unique

  @@map("palabras_prohibidas")
}

model PremioMensual {
  id          Int      @id @default(autoincrement())
  year        Int
  month       Int
  centro      String
  posicion    Int
  titulo      String
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())

  @@map("premios_mensuales")
}

model Torneo {
  id          Int      @id @default(autoincrement())
  nombre      String
  descripcion String?
  tipo        String   // "mensual", "especial", etc.
  curso       String
  fechaInicio DateTime
  fechaFin    DateTime
  estado      String   @default("activo") // "activo", "finalizado"
  ganadorId   Int?
  ganador     User?    @relation("torneosGanados", fields: [ganadorId], references: [id])
  resultados  Json?    // Array de {nick, aciertos, puntuacion}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("torneos")
}

model UserStats {
  id                  Int     @id @default(autoincrement())
  userId              Int     @unique
  user                User    @relation(fields: [userId], references: [id])
  respuestasAcertadas Int     @default(0)
  preguntasFalladas   Int     @default(0)
  victoriasTorneos    Int     @default(0)
  participacionesTorneos Int  @default(0)
  puntuacionTotal     Int     @default(0)

  @@map("user_stats")
}

// Modelo para preguntas (basado en tus JSON)
model Pregunta {
  id        Int     @id @default(autoincrement())
  pregunta  String
  respuesta String
  categoria String
  curso     String  // ej. "1primaria"
  asignatura String // ej. "matematicas"
}

// Modelo para trofeos (basado en tus JSON)
model Trofeo {
  id          Int     @id @default(autoincrement())
  imagen      String
  titulo      String
  descripcion String
  criterio    String
  userTrofeos UserTrofeo[]
}

// Modelo para trofeos desbloqueados por usuario
model UserTrofeo {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  trofeoId    Int
  trofeo      Trofeo   @relation(fields: [trofeoId], references: [id])
  desbloqueado Boolean @default(true)
  createdAt   DateTime @default(now())

  @@unique([userId, trofeoId])
  @@map("user_trofeos")
}
model PremiumData {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  user        User     @relation(fields: [userId], references: [id])
  fechaInicio DateTime?
  fechaExpiracion DateTime?
  activo      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("premium_data")
}

// Modelo para torneos premium del usuario
model TorneoPremium {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  user        User     @relation(fields: [userId], references: [id])
  torneos     Json     // Lista de torneos disponibles
  lastReset   DateTime?
  torneoActivo Json?   // Información del torneo activo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("torneos_premium")
}

// Modelo para estadísticas de competiciones premium
model CompeticionPremium {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  user            User     @relation(fields: [userId], references: [id])
  victorias       Int      @default(0)
  participaciones Int      @default(0)
  puntuacionTotal Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("competiciones_premium")
}

// Modelo para resultados de competiciones
model ChampionshipResult {
  id                  Int      @id @default(autoincrement())
  userId              Int?
  user                User?    @relation(fields: [userId], references: [id])
  centro              String?
  season              String   // ej. "t2025"
  type                String   // "centros", "individual", "docentes"
  ganados             Int      @default(0)
  perdidos            Int      @default(0)
  preguntasAcertadas  Int      @default(0)
  preguntasFalladas   Int      @default(0)
  likes               Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, centro, season, type])
  @@map("championship_results")
}